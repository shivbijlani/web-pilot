# Web-Pilot Development Constitution

## Core Principles

### 1. Background Execution Rule
**ALWAYS** use the `--background` flag for Copilot/LLM testing.

**Setup (first time only):**
```powershell
node src/cli.js --select-profile
```

**Background mode (every time):**
```powershell
node src/cli.js --background
```

The tool handles detaching itself properly and logs to `web-pilot.log`.

**DO NOT:**
- Use `run_in_terminal` with `isBackground: true` (doesn't work properly)
- Try to run --background without saved preferences (will error)

### 2. Process Verification Rule
Always verify the process is running using the PID shown in output:
```powershell
# Output shows: [PID: 12345] [Started: 1/19/2026, 12:45:28 PM]
Get-Process -Id 12345 -ErrorAction SilentlyContinue
```

### 3. Command Writing Rule
Always use UTF-8 encoding without BOM or newlines:
```powershell
'command' | Out-File -FilePath command.txt -Encoding utf8 -NoNewline
```

### 4. Testing Workflow Rule
1. First run: Normal mode for profile selection
2. Kill process after profile selection
3. Subsequent runs: Background mode with saved preferences
4. Use helper scripts: `.\start-background.ps1` and `.\stop-background.ps1`

## Helper Scripts

### Start Background Job
```powershell
.\start-background.ps1
```
This script:
- Stops existing processes
- Starts web-pilot as background job
- Shows PID and job ID
- Keeps terminal free

### Stop Background Job
```powershell
.\stop-background.ps1
```
This script:
- Stops all PowerShell jobs
- Kills node and edge processes
- Verifies cleanup

## Copilot Automation Guidelines

When user requests to test web-pilot:

1. **Check for preferences file**
   ```powershell
   Test-Path .web-pilot-prefs.json
   ```

2. **If no preferences exist**
   - Run setup mode:
     ```powershell
     node src/cli.js --select-profile
     ```
   - User picks profile
   - Preferences saved automatically
   - Process exits (no browser launch)

3. **If preferences exist**
   - Run in background:
     ```powershell
     node src/cli.js --background
     ```
   - Wait 5 seconds for startup
   - Check web-pilot.log for PID and status

4. **Send test commands**
   ```powershell
   'goto:https://example.com' | Out-File -FilePath command.txt -Encoding utf8 -NoNewline
   Start-Sleep -Seconds 5
   Get-Content result.txt
   ```

5. **Cleanup when done**
   - Use `.\stop-background.ps1` OR
   - Stop-Process -Name node/msedge

## Common Pitfalls to Avoid

❌ Running foreground commands in same terminal as background process
❌ Using `isBackground: true` in run_in_terminal
❌ Not verifying PID after starting
❌ Using echo or Set-Content (adds BOM/newlines)
❌ Not waiting long enough for browser startup (needs 5+ seconds)

## File Structure

```
.web-pilot-prefs.json   - User preferences (browser + profile)
command.txt             - Command input file
result.txt              - Command result file
start-background.ps1    - Helper script to start
stop-background.ps1     - Helper script to stop
```

## Success Indicators

✅ Terminal shows: `[PID: 12345] [Started: timestamp]`
✅ `Get-Process -Id 12345` returns process info
✅ Terminal prompt is free (not blocked)
✅ Commands in command.txt are processed
✅ Results appear in result.txt
